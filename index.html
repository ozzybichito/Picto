<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PictoPlan - Secuencias Diarias y Emociones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .app-container {
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .filled-drop-zone {
            border: 2px solid #3b82f6; 
            background-color: #dbeafe;
            cursor: pointer; 
            transition: all 0.2s;
        }
        .filled-drop-zone:active {
             transform: scale(0.99);
        }
        .selected-picto {
            border: 4px solid #f59e0b !important; 
            background-color: #fffbeb !important;
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4);
            transform: scale(1.02);
        }
        .picto-correct {
            border: 4px solid #059669 !important; 
            background-color: #d1fae5 !important; 
        }
        .picto-incorrect {
            border: 4px solid #ef4444 !important; 
            background-color: #fee2e2 !important; 
        }
        #routine-selector {
            appearance: none;
            background-color: #ffffff;
            border: 2px solid #3b82f6;
            padding: 10px;
            border-radius: 12px;
            font-weight: bold;
            color: #1f2937;
            text-align: center;
        }
        .emotion-option {
            background-color: #ffffff;
            border: 2px solid #a8a29e;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-height: 120px; 
            padding-top: 16px; 
            padding-bottom: 16px;
            text-align: center;
        }
        .emotion-option:hover {
            border-color: #fb7185;
            transform: translateY(-2px);
        }
        .emotion-option:active {
            transform: scale(0.98);
        }
        .emotion-primary {
            border: 4px solid #059669 !important; 
            background-color: #d1fae5 !important;
            box-shadow: 0 0 15px #059669;
        }
        .emotion-secondary {
            border: 4px solid #84cc16 !important; 
            background-color: #f0fdf4 !important;
            box-shadow: 0 0 10px #84cc16;
        }
        .emotion-incorrect {
            border: 4px solid #ef4444 !important; 
            background-color: #fee2e2 !important;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #fb7185;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        #scenario-output-box {
            cursor: pointer;
            transition: transform 0.1s ease-in-out;
        }
        #scenario-output-box:active {
            transform: scale(0.99);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="app-container mx-auto flex flex-col items-center w-full">
    <header class="w-full p-4 bg-blue-600 text-white rounded-b-xl shadow-lg">
        <h1 class="text-2xl font-extrabold text-center">PictoPlan</h1>
        <p id="auth-status" class="text-sm text-center mt-1 opacity-90 font-medium">Desarrollado por: Jason Dafnis</p>
    </header>
    <div class="w-full flex justify-center bg-white shadow-md p-2">
        <button id="mode-a-button" class="flex-1 py-2 px-4 text-sm font-bold rounded-l-xl transition-colors border-b-4 border-blue-600 text-blue-600">
            1. Secuencias Diarias
        </button>
        <button id="mode-b-button" class="flex-1 py-2 px-4 text-sm font-bold rounded-r-xl transition-colors text-gray-500 hover:text-blue-500 border-b-4 border-transparent">
            2. Detective Emocional
        </button>
    </div>
    <main class="flex flex-col flex-grow w-full p-4 space-y-4">
        <div id="message-box" class="p-3 text-center rounded-xl font-semibold hidden transition-all"></div>

        <!-- MODO A -->
        <div id="mode-a-content" class="w-full flex flex-col space-y-4">
            <div class="flex flex-col items-center space-y-2">
                <label for="routine-selector" class="text-md font-semibold text-gray-700">Selecciona la Rutina (20 opciones):</label>
                <select id="routine-selector" class="w-full max-w-sm">
                    <option value="morning">1. Ma√±ana (4 Pasos)</option>
                    <option value="night">2. Noche (6 Pasos)</option>
                    <option value="school">3. Regreso a Casa (5 Pasos)</option>
                    <option value="outside">4. Salir de Casa (5 Pasos)</option>
                    <option value="teeth">5. Cepillado Completo (4 Pasos)</option>
                    <option value="washing_hands">6. Lavado de Manos (4 Pasos)</option>
                    <option value="going_to_bathroom">7. Usar el Ba√±o (5 Pasos)</option>
                    <option value="bed_making">8. Hacer la Cama (5 Pasos)</option>
                    <option value="snack">9. Preparaci√≥n Merienda (3 Pasos)</option>
                    <option value="table">10. Poner la Mesa (4 Pasos)</option>
                    <option value="pet_feeding">11. Dar Comida a la Mascota (4 Pasos)</option>
                    <option value="laundry">12. Poner Lavadora (5 Pasos)</option>
                    <option value="taking_out_trash">13. Sacar la Basura (4 Pasos)</option>
                    <option value="watering_plants">14. Regar Plantas (4 Pasos)</option>
                    <option value="buying_food">15. Comprar en la Tienda (5 Pasos)</option>
                    <option value="drawing">16. Dibujar (4 Pasos)</option>
                    <option value="cleaning_desk">17. Limpiar Escritorio (4 Pasos)</option>
                    <option value="playground">18. Ir al Parque (5 Pasos)</option>
                    <option value="birthday">19. Preparar un Cumplea√±os (5 Pasos)</option>
                    <option value="homework_start">20. Empezar Tarea (4 Pasos)</option>
                </select>
            </div>
            <h2 id="routine-title" class="text-xl font-semibold text-gray-700 text-center mt-4"></h2>
            <p class="text-sm text-gray-500 text-center font-medium">
                Haz clic en un pictograma para escucharlo. Haz clic en otro para intercambiar su orden.
            </p>
            <div id="drop-targets" class="flex flex-col space-y-3"></div>
            <button id="check-button" class="w-full py-4 text-white text-xl font-bold bg-green-500 hover:bg-green-600 rounded-2xl transition-all shadow-lg active:scale-[0.98]">
                Verificar Secuencia
            </button>
        </div>

        <!-- MODO B -->
        <div id="mode-b-content" class="w-full flex flex-col space-y-6 hidden">
            <h2 class="text-2xl font-bold text-center text-pink-600">Detective Emocional üß†</h2>
            <p class="text-base text-gray-600 text-center">
                Lee el escenario y elige el pictograma de la emoci√≥n correcta. ¬°Haz clic en el recuadro amarillo para escucharlo de nuevo!
            </p>
            <div class="p-3 bg-indigo-100 rounded-xl shadow-md border border-indigo-400 text-center">
                <p class="text-sm font-medium text-indigo-700">Puntuaci√≥n Local:</p>
                <p id="local-score-display" class="text-2xl font-extrabold text-indigo-900">0 Puntos</p>
            </div>
            <div id="scenario-output-box"
                 class="p-6 bg-yellow-100 rounded-xl shadow-inner border-2 border-yellow-400 flex flex-col items-center space-y-4 min-h-[150px] justify-center relative">
                <p id="target-scenario-text" class="text-lg p-3 font-semibold text-gray-700 text-center italic w-full">Cargando escenario...</p>
                <div id="scenario-loader" class="loader"></div>
            </div>
            <div id="emotion-options-grid" class="grid grid-cols-2 gap-4"></div>
            <button id="next-emotion-button" class="w-full py-4 text-white text-xl font-bold bg-pink-500 hover:bg-pink-600 rounded-2xl transition-all shadow-lg active:scale-[0.98]">
                Siguiente Desaf√≠o
            </button>
        </div>
    </main>
</div>

<script type="module">
    // üîë TU API KEY REAL
    const apiKey = "AIzaSyA9fRfC-z7WOUrwsL1Xl2gqaiAOtNFGNcc";
    // ‚úÖ Corregido: sin espacios en la URL
    const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

    // === DATOS (definidos AL PRINCIPIO para evitar errores) ===
    const ROUTINES_DATA = {
        morning: { title: "Reordena la Rutina de la Ma√±ana (4 Pasos)", sequence: [{ emoji: 'üõå', text: 'Despertar', value: 'despertar' }, { emoji: 'ü•£', text: 'Desayunar', value: 'desayunar' }, { emoji: 'ü¶∑', text: 'Cepillarse los dientes', value: 'cepillarse' }, { emoji: 'üëï', text: 'Vestirse', value: 'vestirse' }] },
        night: { title: "Reordena la Rutina de la Noche (6 Pasos)", sequence: [{ emoji: 'üçΩÔ∏è', text: 'Cenar', value: 'cenar' }, { emoji: 'üõÄ', text: 'Ba√±arse', value: 'ba√±arse' }, { emoji: 'üëö', text: 'Ponerse el Pijama', value: 'pijama' }, { emoji: 'ü¶∑', text: 'Cepillarse los dientes', value: 'cepillarse_noche' }, { emoji: 'üìö', text: 'Leer un Cuento', value: 'cuento' }, { emoji: 'üò¥', text: 'Dormir', value: 'dormir' }] },
        school: { title: "Regreso a Casa (5 Pasos)", sequence: [{ emoji: 'üéí', text: 'Quitarse la Mochila', value: 'mochila' }, { emoji: 'üëã', text: 'Lavar Manos', value: 'manos' }, { emoji: 'üçé', text: 'Merendar', value: 'merendar' }, { emoji: '‚úèÔ∏è', text: 'Hacer la Tarea', value: 'tarea' }, { emoji: '‚öΩ', text: 'Jugar Tiempo Libre', value: 'jugar' }] },
        outside: { title: "Rutina para Salir de Casa (5 Pasos)", sequence: [{ emoji: 'üß¶', text: 'Ponerse Calcetines', value: 'calcetines' }, { emoji: 'üëü', text: 'Ponerse Zapatos', value: 'zapatos' }, { emoji: 'üß•', text: 'Ponerse Abrigo', value: 'abrigo' }, { emoji: 'üîë', text: 'Tomar Llaves', value: 'llaves' }, { emoji: 'üö™', text: 'Abrir Puerta y Salir', value: 'salir' }] },
        teeth: { title: "Rutina de Cepillado Completo (4 Pasos)", sequence: [{ emoji: 'üö∞', text: 'Mojar el Cepillo', value: 'mojar' }, { emoji: 'üß¥', text: 'Poner Pasta', value: 'pasta' }, { emoji: 'ü¶∑', text: 'Cepillar por dos minutos', value: 'cepillar' }, { emoji: 'üí¶', text: 'Enjuagar y Escupir', value: 'enjuagar' }] },
        washing_hands: { title: "Rutina de Lavado de Manos (4 Pasos)", sequence: [{ emoji: 'üö∞', text: 'Abrir el Agua y Mojar', value: 'mojar_manos' }, { emoji: 'üßº', text: 'Usar Jab√≥n', value: 'jabon' }, { emoji: 'üñêÔ∏è', text: 'Frotar las manos', value: 'frotar' }, { emoji: 'üßª', text: 'Secar con Toalla', value: 'secar' }] },
        going_to_bathroom: { title: "Rutina de Usar el Ba√±o (5 Pasos)", sequence: [{ emoji: 'üëñ', text: 'Bajar la Ropa', value: 'bajar_ropa' }, { emoji: 'üöΩ', text: 'Usar el Inodoro', value: 'usar_inodoro' }, { emoji: 'üßª', text: 'Limpiarse', value: 'limpiarse' }, { emoji: 'üëÜ', text: 'Subir la Ropa', value: 'subir_ropa' }, { emoji: 'üëã', text: 'Lavar Manos', value: 'lavar_manos_final' }] },
        bed_making: { title: "Rutina de Hacer la Cama (5 Pasos)", sequence: [{ emoji: '‚¨ÜÔ∏è', text: 'Estirar la S√°bana de Abajo', value: 'estirar_sabana' }, { emoji: 'üõèÔ∏è', text: 'Acomodar la Almohada', value: 'acomodar_almohada' }, { emoji: 'üõå', text: 'Estirar la Frazada', value: 'estirar_frazada' }, { emoji: 'üß∏', text: 'Colocar los Peluches', value: 'colocar_adornos' }, { emoji: '‚úîÔ∏è', text: 'Verificar el Orden', value: 'verificar_cama' }] },
        snack: { title: "Preparaci√≥n de Merienda (3 Pasos)", sequence: [{ emoji: 'üö∞', text: 'Lavar la Fruta', value: 'lavar' }, { emoji: 'üî™', text: 'Cortar la Fruta', value: 'cortar' }, { emoji: 'üòã', text: 'Comer la Merienda', value: 'comer' }] },
        table: { title: "Rutina de Poner la Mesa (4 Pasos)", sequence: [{ emoji: 'üß∫', text: 'Traer el Mantel', value: 'mantel' }, { emoji: 'üçΩÔ∏è', text: 'Colocar los Platos', value: 'platos' }, { emoji: 'üç¥', text: 'Colocar los Cubiertos', value: 'cubiertos' }, { emoji: 'ü•õ', text: 'Colocar los Vasos', value: 'vasos' }] },
        pet_feeding: { title: "Rutina de Dar Comida a la Mascota (4 Pasos)", sequence: [{ emoji: 'ü•£', text: 'Tomar el Plato', value: 'tomar_plato' }, { emoji: 'ü•´', text: 'Servir la Comida', value: 'servir_comida' }, { emoji: 'üêï', text: 'Colocar en Su Lugar', value: 'colocar_lugar' }, { emoji: 'üíß', text: 'Revisar el Agua', value: 'revisar_agua' }] },
        laundry: { title: "Rutina de Poner Lavadora (5 Pasos)", sequence: [{ emoji: 'üß∫', text: 'Separar la Ropa (Color/Blanco)', value: 'separar_ropa' }, { emoji: 'üëï', text: 'Meter la Ropa a la Lavadora', value: 'meter_ropa' }, { emoji: 'üß¥', text: 'Poner Jab√≥n', value: 'poner_jabon' }, { emoji: '‚öôÔ∏è', text: 'Seleccionar el Programa', value: 'seleccionar_programa' }, { emoji: '‚ñ∂Ô∏è', text: 'Presionar Inicio', value: 'inicio_lavado' }] },
        taking_out_trash: { title: "Rutina de Sacar la Basura (4 Pasos)", sequence: [{ emoji: 'üóëÔ∏è', text: 'Recoger las Bolsas de Basura', value: 'recoger_bolsas' }, { emoji: 'üö™', text: 'Abrir la Puerta y Salir', value: 'abrir_puerta' }, { emoji: 'üöõ', text: 'Depositar en el Contenedor', value: 'depositar' }, { emoji: 'üëã', text: 'Lavar Manos al Volver', value: 'lavar_manos_basura' }] },
        watering_plants: { title: "Rutina de Regar Plantas (4 Pasos)", sequence: [{ emoji: 'üö∞', text: 'Llenar la Regadera con Agua', value: 'llenar_regadera' }, { emoji: 'ü™¥', text: 'Ir a las Plantas', value: 'ir_plantas' }, { emoji: 'üí¶', text: 'Regar con Cuidado', value: 'regar' }, { emoji: '‚òÄÔ∏è', text: 'Guardar la Regadera', value: 'guardar_regadera' }] },
        buying_food: { title: "Rutina de Comprar en la Tienda (5 Pasos)", sequence: [{ emoji: 'üõçÔ∏è', text: 'Tomar la Bolsa Reutilizable', value: 'bolsa' }, { emoji: 'üõí', text: 'Buscar Productos', value: 'buscar_productos' }, { emoji: 'üí∞', text: 'Pagar en Caja', value: 'pagar' }, { emoji: 'üö∂', text: 'Regresar a Casa', value: 'regresar' }, { emoji: 'üì¶', text: 'Guardar las Compras', value: 'guardar_compras' }] },
        drawing: { title: "Preparaci√≥n para Dibujar (4 Pasos)", sequence: [{ emoji: 'üñçÔ∏è', text: 'Sacar L√°pices de Colores', value: 'sacar_lapices' }, { emoji: 'üìÑ', text: 'Poner la Hoja en la Mesa', value: 'poner_hoja' }, { emoji: 'üé®', text: 'Empezar a Dibujar', value: 'empezar_dibujar' }, { emoji: 'üóëÔ∏è', text: 'Recoger el Material', value: 'recoger_material' }] },
        cleaning_desk: { title: "Rutina de Limpiar Escritorio (4 Pasos)", sequence: [{ emoji: 'üìö', text: 'Quitar libros y objetos', value: 'quitar_objetos' }, { emoji: 'üßΩ', text: 'Pasar el pa√±o h√∫medo', value: 'pasar_pano' }, { emoji: 'üóëÔ∏è', text: 'Vaciar la papelera', value: 'vaciar_papelera' }, { emoji: '‚úîÔ∏è', text: 'Organizar el material', value: 'organizar_material' }] },
        playground: { title: "Rutina de Ir al Parque (5 Pasos)", sequence: [{ emoji: '‚òÄÔ∏è', text: 'Poner Bloqueador Solar', value: 'bloqueador' }, { emoji: 'üëü', text: 'Poner Zapatos', value: 'zapatos_parque' }, { emoji: 'üîë', text: 'Tomar Pelota o Juguete', value: 'tomar_juguete' }, { emoji: 'üö∂', text: 'Caminar al Parque', value: 'caminar' }, { emoji: '‚öΩ', text: 'Empezar a Jugar', value: 'empezar_jugar' }] },
        birthday: { title: "Preparar un Cumplea√±os (5 Pasos)", sequence: [{ emoji: 'üéà', text: 'Inflar y Colgar Globos', value: 'colgar_globos' }, { emoji: 'üéÇ', text: 'Poner el Pastel en la Mesa', value: 'poner_pastel' }, { emoji: 'üéÅ', text: 'Colocar los Regalos', value: 'colocar_regalos' }, { emoji: 'üé∂', text: 'Poner M√∫sica', value: 'poner_musica' }, { emoji: 'üõéÔ∏è', text: 'Esperar a los Invitados', value: 'esperar_invitados' }] },
        homework_start: { title: "Empezar Tarea (4 Pasos)", sequence: [{ emoji: 'üçé', text: 'Tomar un Vaso de Agua', value: 'agua_tarea' }, { emoji: 'üìö', text: 'Sacar Cuadernos Necesarios', value: 'sacar_cuadernos' }, { emoji: 'ü™ë', text: 'Sentarse en el Escritorio', value: 'sentarse' }, { emoji: 'üß†', text: 'Concentrarse y Empezar', value: 'empezar_concentrarse' }] }
    };

    const EMOTION_DATA = [
        { name: 'Feliz', emoji: 'üòä', color: 'green' },
        { name: 'Triste', emoji: 'üò¢', color: 'blue' },
        { name: 'Enojado', emoji: 'üò°', color: 'red' },
        { name: 'Asustado', emoji: 'üò®', color: 'purple' },
        { name: 'Calmado', emoji: 'üòå', color: 'teal' },
        { name: 'Sorprendido', emoji: 'üò≤', color: 'orange' },
        { name: 'Pensativo', emoji: 'ü§î', color: 'indigo' }, 
        { name: 'Aburrido', emoji: 'üòë', color: 'gray' },
        { name: 'Avergonzado', emoji: 'üò≥', color: 'pink' },
        { name: 'Orgulloso', emoji: 'üòé', color: 'lime' },
        { name: 'Decepci√≥n', emoji: 'üòû', color: 'brown' },
        { name: 'Nervioso', emoji: 'üò¨', color: 'yellow' }
    ];

    // Variables globales
    let currentMode = 'A';
    let isLocked = false;
    let emotionScore = 0;
    const LOCAL_STORAGE_KEY = 'PictoPlanScore';
    const PRIMARY_SCORE = 3;
    const SECONDARY_SCORE = 1;

    // DOM Elements
    const modeAButton = document.getElementById('mode-a-button');
    const modeBButton = document.getElementById('mode-b-button');
    const modeAContent = document.getElementById('mode-a-content');
    const modeBContent = document.getElementById('mode-b-content');
    const messageBox = document.getElementById('message-box');
    const authStatusEl = document.getElementById('auth-status');
    const dropTargetsEl = document.getElementById('drop-targets');
    const routineTitleEl = document.getElementById('routine-title');
    const routineSelectorEl = document.getElementById('routine-selector');
    const checkButton = document.getElementById('check-button');
    const scenarioOutputBox = document.getElementById('scenario-output-box');
    const targetScenarioText = document.getElementById('target-scenario-text');
    const scenarioLoader = document.getElementById('scenario-loader');
    const emotionOptionsGrid = document.getElementById('emotion-options-grid');
    const nextEmotionButton = document.getElementById('next-emotion-button');
    const localScoreDisplay = document.getElementById('local-score-display');

    const today = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
    authStatusEl.innerHTML = `Fecha: ${today} | Desarrollado por: Jason Dafnis`;

    // === TTS con Web Speech API (optimizado para m√≥viles) ===
    function speakText(text) {
        if (!text || typeof speechSynthesis === 'undefined') return;
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'es-ES';
        utterance.rate = 0.9;
        utterance.pitch = 1.0;

        // Intentar usar voz en espa√±ol
        const voices = speechSynthesis.getVoices();
        const spanishVoice = voices.find(v => v.lang.startsWith('es-ES'));
        if (spanishVoice) utterance.voice = spanishVoice;

        speechSynthesis.speak(utterance);
    }

    // Cargar voces al inicio (cr√≠tico en iOS/Safari)
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => {};
    }

    // === UTILS ===
    function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    function showMessage(text, classes) {
        messageBox.innerHTML = text;
        messageBox.className = `p-3 text-center rounded-xl font-bold transition-all ${classes}`;
        messageBox.classList.remove('hidden');
        setTimeout(() => messageBox.classList.add('hidden'), 8000);
    }

    // === MODO A ===
    let currentSequence = [];
    let currentCorrectSequence = [];
    let selectedPictoIndex = null;
    let validationStatus = [];

    function renderSequence() {
        dropTargetsEl.innerHTML = '';
        currentSequence.forEach((item, index) => {
            const target = document.createElement('div');
            let classes = 'filled-drop-zone p-4 flex items-center h-24 font-bold transition-all shadow-sm ';
            if (index === selectedPictoIndex) classes += ' selected-picto';
            else if (validationStatus[index] === 'correct') classes += ' picto-correct';
            else if (validationStatus[index] === 'incorrect') classes += ' picto-incorrect';
            target.className = classes + ' w-full';
            target.innerHTML = `<span class="text-3xl font-extrabold mr-4">${index + 1}.</span> 
                                <div class="flex items-center space-x-4">
                                    <span class="text-5xl">${item.emoji}</span>
                                    <span class="text-lg font-bold text-gray-800">${item.text}</span>
                                </div>`;
            target.addEventListener('click', () => {
                speakText(item.text);
                handleTargetClick(index);
            });
            dropTargetsEl.appendChild(target);
        });
    }

    function handleTargetClick(clickedIndex) {
        validationStatus = [];
        if (selectedPictoIndex === null) {
            selectedPictoIndex = clickedIndex;
            showMessage('Pictograma seleccionado. ¬°Haz clic en otro para intercambiar!', 'bg-yellow-100 text-yellow-800');
            renderSequence();
        } else {
            if (selectedPictoIndex === clickedIndex) {
                selectedPictoIndex = null;
                showMessage('Selecci√≥n cancelada.', 'bg-gray-200 text-gray-700');
            } else {
                [currentSequence[selectedPictoIndex], currentSequence[clickedIndex]] = [currentSequence[clickedIndex], currentSequence[selectedPictoIndex]];
                selectedPictoIndex = null;
                showMessage('¬°Intercambio realizado! Revisa el orden.', 'bg-green-100 text-green-800');
            }
            renderSequence();
        }
    }

    function loadRoutine(routineKey) {
        const routineData = ROUTINES_DATA[routineKey];
        if (!routineData) return;
        routineTitleEl.textContent = routineData.title;
        currentCorrectSequence = routineData.sequence;
        currentSequence = shuffleArray(routineData.sequence);
        selectedPictoIndex = null;
        validationStatus = [];
        renderSequence();
        messageBox.classList.add('hidden');
    }

    function checkSequence() {
        if (selectedPictoIndex !== null) {
            showMessage('Debes deseleccionar o completar el intercambio antes de verificar.', 'bg-yellow-100 text-yellow-800');
            return;
        }
        const correctValues = currentCorrectSequence.map(item => item.value);
        let allCorrect = true;
        validationStatus = [];
        for (let i = 0; i < currentSequence.length; i++) {
            if (currentSequence[i].value !== correctValues[i]) {
                allCorrect = false;
                validationStatus[i] = 'incorrect';
            } else {
                validationStatus[i] = 'correct';
            }
        }
        if (allCorrect) {
            const msg = '¬°Felicidades! üéâ La secuencia es COMPLETAMENTE CORRECTA. ¬°Excelente trabajo!';
            showMessage(msg, 'bg-emerald-100 text-emerald-800');
            speakText('Felicidades! La secuencia es completamente correcta. ¬°Excelente trabajo!');
            setTimeout(() => {
                const keys = Object.keys(ROUTINES_DATA);
                const idx = keys.indexOf(routineSelectorEl.value);
                const next = keys[(idx + 1) % keys.length];
                routineSelectorEl.value = next;
                loadRoutine(next);
            }, 3000);
        } else {
            const msg = 'A√∫n no es correcto. üßê Revisa los pasos marcados en rojo e intenta intercambiarlos.';
            showMessage(msg, 'bg-rose-100 text-rose-800');
            speakText('A√∫n no es correcto. Revisa los pasos marcados en rojo e intenta intercambiarlos.');
        }
        renderSequence();
    }

    // === MODO B ===
    let currentTargetResponse = null;

    async function requestNewScenario() {
        scenarioLoader.classList.remove('hidden');
        targetScenarioText.textContent = 'Cargando un nuevo escenario emocional...';
        isLocked = true;
        try {
            const prompt = `Act√∫a como un psic√≥logo infantil experto en autismo y crea un escenario breve y realista (m√°ximo 40 palabras) donde un ni√±o o ni√±a experimenta una emoci√≥n clara. La emoci√≥n DEBE ser una de las siguientes: Feliz, Triste, Enojado, Asustado, Calmado, Sorprendido, Pensativo, Aburrido, Avergonzado, Orgulloso, Decepci√≥n, Nervioso. 
            Devuelve la respuesta como un objeto JSON estricto con la siguiente estructura:
            {
              "scenario": "Descripci√≥n del escenario.",
              "primary_emotion": "Emoci√≥n principal que experimenta el ni√±o (de la lista proporcionada).",
              "secondary_emotions": ["Emoci√≥n secundaria o cercana (de la lista)"]
            }`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json"
                }
            };
            const res = await fetch(TEXT_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error(`API error: ${res.status}`);
            const data = await res.json();
            const jsonText = data.candidates[0].content.parts[0].text;
            const parsed = JSON.parse(jsonText);
            currentTargetResponse = parsed;
            targetScenarioText.textContent = parsed.scenario;
            scenarioLoader.classList.add('hidden');
            isLocked = false;
            generateEmotionOptions(parsed.primary_emotion);
            speakText(parsed.scenario);
        } catch (error) {
            console.error("Error:", error);
            targetScenarioText.textContent = '‚ùå Error al cargar el desaf√≠o. Intenta de nuevo.';
            scenarioLoader.classList.add('hidden');
            isLocked = true;
        }
    }

    function generateEmotionOptions(correctName) {
        emotionOptionsGrid.innerHTML = '';
        const correct = EMOTION_DATA.find(e => e.name === correctName);
        if (!correct) return;
        const incorrects = EMOTION_DATA.filter(e => e.name !== correctName);
        const selectedIncorrect = shuffleArray(incorrects).slice(0, 3);
        const options = shuffleArray([...selectedIncorrect, correct]);
        options.forEach(emotion => {
            const btn = document.createElement('button');
            btn.className = 'emotion-option rounded-xl active:scale-[0.98] transition-transform';
            btn.innerHTML = `<span class="text-5xl">${emotion.emoji}</span><span class="block mt-2 text-lg font-bold">${emotion.name}</span>`;
            btn.addEventListener('click', () => handleEmotionSelection(emotion.name, btn));
            emotionOptionsGrid.appendChild(btn);
        });
        nextEmotionButton.disabled = true;
    }

    function handleEmotionSelection(name, btn) {
        if (isLocked) return;
        isLocked = true;
        document.querySelectorAll('.emotion-option').forEach(b => b.disabled = true);
        const correct = currentTargetResponse.primary_emotion;
        const secondary = currentTargetResponse.secondary_emotions || [];
        let feedback = '', score = 0;
        if (name === correct) {
            btn.classList.add('emotion-primary');
            score = PRIMARY_SCORE;
            feedback = `¬°S√∫per! üåü La emoci√≥n principal era ${correct}. Ganaste ${score} puntos.`;
        } else if (secondary.includes(name)) {
            btn.classList.add('emotion-secondary');
            score = SECONDARY_SCORE;
            feedback = `¬°Bien! üëç ${name} es una emoci√≥n cercana a la principal (${correct}). Ganaste ${score} punto.`;
        } else {
            btn.classList.add('emotion-incorrect');
            document.querySelectorAll('.emotion-option').forEach(b => {
                if (b.textContent.includes(correct)) b.classList.add('emotion-primary');
            });
            feedback = `Incorrecto. üòî La emoci√≥n principal era ${correct}. Sigue practicando.`;
        }
        emotionScore += score;
        localStorage.setItem(LOCAL_STORAGE_KEY, emotionScore.toString());
        updateScoreDisplay();
        showMessage(feedback, score > 0 ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800');
        speakText(feedback);
        nextEmotionButton.disabled = false;
    }

    function loadLocalScore() {
        const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
        emotionScore = saved ? parseInt(saved, 10) : 0;
        updateScoreDisplay();
    }

    function updateScoreDisplay() {
        localScoreDisplay.textContent = `${emotionScore} Puntos`;
    }

    function loadEmotionDetector() {
        isLocked = true;
        nextEmotionButton.disabled = true;
        emotionOptionsGrid.innerHTML = '';
        requestNewScenario();
        loadLocalScore();
    }

    // === EVENTOS ===
    modeAButton.addEventListener('click', () => switchMode('A'));
    modeBButton.addEventListener('click', () => switchMode('B'));
    routineSelectorEl.addEventListener('change', (e) => loadRoutine(e.target.value));
    checkButton.addEventListener('click', checkSequence);
    nextEmotionButton.addEventListener('click', loadEmotionDetector);
    scenarioOutputBox.addEventListener('click', () => {
        if (!isLocked && currentTargetResponse?.scenario) {
            speakText(currentTargetResponse.scenario);
        }
    });

    function switchMode(mode) {
        if (currentMode === mode) return;
        currentMode = mode;
        speechSynthesis.cancel();
        messageBox.classList.add('hidden');
        if (mode === 'A') {
            modeAContent.classList.remove('hidden');
            modeBContent.classList.add('hidden');
            modeAButton.classList.replace('text-gray-500', 'text-blue-600');
            modeAButton.classList.replace('border-transparent', 'border-blue-600');
            modeBButton.classList.replace('text-blue-600', 'text-gray-500');
            modeBButton.classList.replace('border-blue-600', 'border-transparent');
            loadRoutine(routineSelectorEl.value);
        } else {
            modeAContent.classList.add('hidden');
            modeBContent.classList.remove('hidden');
            modeBButton.classList.replace('text-gray-500', 'text-pink-600');
            modeBButton.classList.replace('border-transparent', 'border-pink-600');
            modeAButton.classList.replace('text-blue-600', 'text-gray-500');
            modeAButton.classList.replace('border-blue-600', 'border-transparent');
            loadEmotionDetector();
        }
    }

    // === INICIO ===
    window.onload = () => {
        switchMode('A');
        // Cargar voces despu√©s de un breve retraso (mejora compatibilidad m√≥vil)
        setTimeout(() => speechSynthesis.getVoices(), 500);
    };
</script>
</body>
</html>
