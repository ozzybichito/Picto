<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PictoPlan - Secuencias Diarias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .app-container {
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .filled-drop-zone {
            border: 2px solid #3b82f6;
            background-color: #dbeafe;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filled-drop-zone:active {
            transform: scale(0.99);
        }
        .selected-picto {
            border: 4px solid #f59e0b !important;
            background-color: #fffbeb !important;
            box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4);
            transform: scale(1.02);
        }
        .picto-correct {
            border: 4px solid #059669 !important;
            background-color: #d1fae5 !important;
        }
        .picto-incorrect {
            border: 4px solid #ef4444 !important;
            background-color: #fee2e2 !important;
        }
        #routine-selector {
            appearance: none;
            background-color: #ffffff;
            border: 2px solid #3b82f6;
            padding: 10px;
            border-radius: 12px;
            font-weight: bold;
            color: #1f2937;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="app-container mx-auto flex flex-col items-center w-full">
    <header class="w-full p-4 bg-blue-600 text-white rounded-b-xl shadow-lg">
        <h1 class="text-2xl font-extrabold text-center">PictoPlan</h1>
        <p id="auth-status" class="text-sm text-center mt-1 opacity-90 font-medium">Desarrollado por: Jason Dafnis</p>
    </header>

    <main class="flex flex-col flex-grow w-full p-4 space-y-4">
        <div id="message-box" class="p-3 text-center rounded-xl font-semibold hidden transition-all"></div>

        <!-- MODO A: Secuencias Diarias -->
        <div id="mode-a-content" class="w-full flex flex-col space-y-4">
            <div class="flex flex-col items-center space-y-2">
                <label for="routine-selector" class="text-md font-semibold text-gray-700">Selecciona la Rutina (20 opciones):</label>
                <select id="routine-selector" class="w-full max-w-sm">
                    <option value="morning">1. Mañana (4 Pasos)</option>
                    <option value="night">2. Noche (6 Pasos)</option>
                    <option value="school">3. Regreso a Casa (5 Pasos)</option>
                    <option value="outside">4. Salir de Casa (5 Pasos)</option>
                    <option value="teeth">5. Cepillado Completo (4 Pasos)</option>
                    <option value="washing_hands">6. Lavado de Manos (4 Pasos)</option>
                    <option value="going_to_bathroom">7. Usar el Baño (5 Pasos)</option>
                    <option value="bed_making">8. Hacer la Cama (5 Pasos)</option>
                    <option value="snack">9. Preparación Merienda (3 Pasos)</option>
                    <option value="table">10. Poner la Mesa (4 Pasos)</option>
                    <option value="pet_feeding">11. Dar Comida a la Mascota (4 Pasos)</option>
                    <option value="laundry">12. Poner Lavadora (5 Pasos)</option>
                    <option value="taking_out_trash">13. Sacar la Basura (4 Pasos)</option>
                    <option value="watering_plants">14. Regar Plantas (4 Pasos)</option>
                    <option value="buying_food">15. Comprar en la Tienda (5 Pasos)</option>
                    <option value="drawing">16. Dibujar (4 Pasos)</option>
                    <option value="cleaning_desk">17. Limpiar Escritorio (4 Pasos)</option>
                    <option value="playground">18. Ir al Parque (5 Pasos)</option>
                    <option value="birthday">19. Preparar un Cumpleaños (5 Pasos)</option>
                    <option value="homework_start">20. Empezar Tarea (4 Pasos)</option>
                </select>
            </div>
            <h2 id="routine-title" class="text-xl font-semibold text-gray-700 text-center mt-4"></h2>
            <p class="text-sm text-gray-500 text-center font-medium">
                Haz clic en un pictograma para escucharlo. Haz clic en otro para intercambiar su orden.
            </p>
            <div id="drop-targets" class="flex flex-col space-y-3"></div>
            <button id="check-button" class="w-full py-4 text-white text-xl font-bold bg-green-500 hover:bg-green-600 rounded-2xl transition-all shadow-lg active:scale-[0.98]">
                Verificar Secuencia
            </button>
        </div>
    </main>
</div>

<script type="module">
    // === DATOS LOCALES ===
    const ROUTINES_DATA = {
        morning: { title: "Reordena la Rutina de la Mañana (4 Pasos)", sequence: [{ emoji: '🛌', text: 'Despertar', value: 'despertar' }, { emoji: '🥣', text: 'Desayunar', value: 'desayunar' }, { emoji: '🦷', text: 'Cepillarse los dientes', value: 'cepillarse' }, { emoji: '👕', text: 'Vestirse', value: 'vestirse' }] },
        night: { title: "Reordena la Rutina de la Noche (6 Pasos)", sequence: [{ emoji: '🍽️', text: 'Cenar', value: 'cenar' }, { emoji: '🛀', text: 'Bañarse', value: 'bañarse' }, { emoji: '👚', text: 'Ponerse el Pijama', value: 'pijama' }, { emoji: '🦷', text: 'Cepillarse los dientes', value: 'cepillarse_noche' }, { emoji: '📚', text: 'Leer un Cuento', value: 'cuento' }, { emoji: '😴', text: 'Dormir', value: 'dormir' }] },
        school: { title: "Regreso a Casa (5 Pasos)", sequence: [{ emoji: '🎒', text: 'Quitarse la Mochila', value: 'mochila' }, { emoji: '👋', text: 'Lavar Manos', value: 'manos' }, { emoji: '🍎', text: 'Merendar', value: 'merendar' }, { emoji: '✏️', text: 'Hacer la Tarea', value: 'tarea' }, { emoji: '⚽', text: 'Jugar Tiempo Libre', value: 'jugar' }] },
        outside: { title: "Rutina para Salir de Casa (5 Pasos)", sequence: [{ emoji: '🧦', text: 'Ponerse Calcetines', value: 'calcetines' }, { emoji: '👟', text: 'Ponerse Zapatos', value: 'zapatos' }, { emoji: '🧥', text: 'Ponerse Abrigo', value: 'abrigo' }, { emoji: '🔑', text: 'Tomar Llaves', value: 'llaves' }, { emoji: '🚪', text: 'Abrir Puerta y Salir', value: 'salir' }] },
        teeth: { title: "Rutina de Cepillado Completo (4 Pasos)", sequence: [{ emoji: '🚰', text: 'Mojar el Cepillo', value: 'mojar' }, { emoji: '🧴', text: 'Poner Pasta', value: 'pasta' }, { emoji: '🦷', text: 'Cepillar por dos minutos', value: 'cepillar' }, { emoji: '💦', text: 'Enjuagar y Escupir', value: 'enjuagar' }] },
        washing_hands: { title: "Rutina de Lavado de Manos (4 Pasos)", sequence: [{ emoji: '🚰', text: 'Abrir el Agua y Mojar', value: 'mojar_manos' }, { emoji: '🧼', text: 'Usar Jabón', value: 'jabon' }, { emoji: '🖐️', text: 'Frotar las manos', value: 'frotar' }, { emoji: '🧻', text: 'Secar con Toalla', value: 'secar' }] },
        going_to_bathroom: { title: "Rutina de Usar el Baño (5 Pasos)", sequence: [{ emoji: '👖', text: 'Bajar la Ropa', value: 'bajar_ropa' }, { emoji: '🚽', text: 'Usar el Inodoro', value: 'usar_inodoro' }, { emoji: '🧻', text: 'Limpiarse', value: 'limpiarse' }, { emoji: '👆', text: 'Subir la Ropa', value: 'subir_ropa' }, { emoji: '👋', text: 'Lavar Manos', value: 'lavar_manos_final' }] },
        bed_making: { title: "Rutina de Hacer la Cama (5 Pasos)", sequence: [{ emoji: '⬆️', text: 'Estirar la Sábana de Abajo', value: 'estirar_sabana' }, { emoji: '🛏️', text: 'Acomodar la Almohada', value: 'acomodar_almohada' }, { emoji: '🛌', text: 'Estirar la Frazada', value: 'estirar_frazada' }, { emoji: '🧸', text: 'Colocar los Peluches', value: 'colocar_adornos' }, { emoji: '✔️', text: 'Verificar el Orden', value: 'verificar_cama' }] },
        snack: { title: "Preparación de Merienda (3 Pasos)", sequence: [{ emoji: '🚰', text: 'Lavar la Fruta', value: 'lavar' }, { emoji: '🔪', text: 'Cortar la Fruta', value: 'cortar' }, { emoji: '😋', text: 'Comer la Merienda', value: 'comer' }] },
        table: { title: "Rutina de Poner la Mesa (4 Pasos)", sequence: [{ emoji: '🧺', text: 'Traer el Mantel', value: 'mantel' }, { emoji: '🍽️', text: 'Colocar los Platos', value: 'platos' }, { emoji: '🍴', text: 'Colocar los Cubiertos', value: 'cubiertos' }, { emoji: '🥛', text: 'Colocar los Vasos', value: 'vasos' }] },
        pet_feeding: { title: "Rutina de Dar Comida a la Mascota (4 Pasos)", sequence: [{ emoji: '🥣', text: 'Tomar el Plato', value: 'tomar_plato' }, { emoji: '🥫', text: 'Servir la Comida', value: 'servir_comida' }, { emoji: '🐕', text: 'Colocar en Su Lugar', value: 'colocar_lugar' }, { emoji: '💧', text: 'Revisar el Agua', value: 'revisar_agua' }] },
        laundry: { title: "Rutina de Poner Lavadora (5 Pasos)", sequence: [{ emoji: '🧺', text: 'Separar la Ropa (Color/Blanco)', value: 'separar_ropa' }, { emoji: '👕', text: 'Meter la Ropa a la Lavadora', value: 'meter_ropa' }, { emoji: '🧴', text: 'Poner Jabón', value: 'poner_jabon' }, { emoji: '⚙️', text: 'Seleccionar el Programa', value: 'seleccionar_programa' }, { emoji: '▶️', text: 'Presionar Inicio', value: 'inicio_lavado' }] },
        taking_out_trash: { title: "Rutina de Sacar la Basura (4 Pasos)", sequence: [{ emoji: '🗑️', text: 'Recoger las Bolsas de Basura', value: 'recoger_bolsas' }, { emoji: '🚪', text: 'Abrir la Puerta y Salir', value: 'abrir_puerta' }, { emoji: '🚛', text: 'Depositar en el Contenedor', value: 'depositar' }, { emoji: '👋', text: 'Lavar Manos al Volver', value: 'lavar_manos_basura' }] },
        watering_plants: { title: "Rutina de Regar Plantas (4 Pasos)", sequence: [{ emoji: '🚰', text: 'Llenar la Regadera con Agua', value: 'llenar_regadera' }, { emoji: '🪴', text: 'Ir a las Plantas', value: 'ir_plantas' }, { emoji: '💦', text: 'Regar con Cuidado', value: 'regar' }, { emoji: '☀️', text: 'Guardar la Regadera', value: 'guardar_regadera' }] },
        buying_food: { title: "Rutina de Comprar en la Tienda (5 Pasos)", sequence: [{ emoji: '🛍️', text: 'Tomar la Bolsa Reutilizable', value: 'bolsa' }, { emoji: '🛒', text: 'Buscar Productos', value: 'buscar_productos' }, { emoji: '💰', text: 'Pagar en Caja', value: 'pagar' }, { emoji: '🚶', text: 'Regresar a Casa', value: 'regresar' }, { emoji: '📦', text: 'Guardar las Compras', value: 'guardar_compras' }] },
        drawing: { title: "Preparación para Dibujar (4 Pasos)", sequence: [{ emoji: '🖍️', text: 'Sacar Lápices de Colores', value: 'sacar_lapices' }, { emoji: '📄', text: 'Poner la Hoja en la Mesa', value: 'poner_hoja' }, { emoji: '🎨', text: 'Empezar a Dibujar', value: 'empezar_dibujar' }, { emoji: '🗑️', text: 'Recoger el Material', value: 'recoger_material' }] },
        cleaning_desk: { title: "Rutina de Limpiar Escritorio (4 Pasos)", sequence: [{ emoji: '📚', text: 'Quitar libros y objetos', value: 'quitar_objetos' }, { emoji: '🧽', text: 'Pasar el paño húmedo', value: 'pasar_pano' }, { emoji: '🗑️', text: 'Vaciar la papelera', value: 'vaciar_papelera' }, { emoji: '✔️', text: 'Organizar el material', value: 'organizar_material' }] },
        playground: { title: "Rutina de Ir al Parque (5 Pasos)", sequence: [{ emoji: '☀️', text: 'Poner Bloqueador Solar', value: 'bloqueador' }, { emoji: '👟', text: 'Poner Zapatos', value: 'zapatos_parque' }, { emoji: '🔑', text: 'Tomar Pelota o Juguete', value: 'tomar_juguete' }, { emoji: '🚶', text: 'Caminar al Parque', value: 'caminar' }, { emoji: '⚽', text: 'Empezar a Jugar', value: 'empezar_jugar' }] },
        birthday: { title: "Preparar un Cumpleaños (5 Pasos)", sequence: [{ emoji: '🎈', text: 'Inflar y Colgar Globos', value: 'colgar_globos' }, { emoji: '🎂', text: 'Poner el Pastel en la Mesa', value: 'poner_pastel' }, { emoji: '🎁', text: 'Colocar los Regalos', value: 'colocar_regalos' }, { emoji: '🎶', text: 'Poner Música', value: 'poner_musica' }, { emoji: '🛎️', text: 'Esperar a los Invitados', value: 'esperar_invitados' }] },
        homework_start: { title: "Empezar Tarea (4 Pasos)", sequence: [{ emoji: '🍎', text: 'Tomar un Vaso de Agua', value: 'agua_tarea' }, { emoji: '📚', text: 'Sacar Cuadernos Necesarios', value: 'sacar_cuadernos' }, { emoji: '🪑', text: 'Sentarse en el Escritorio', value: 'sentarse' }, { emoji: '🧠', text: 'Concentrarse y Empezar', value: 'empezar_concentrarse' }] }
    };

    // DOM Elements
    const dropTargetsEl = document.getElementById('drop-targets');
    const routineTitleEl = document.getElementById('routine-title');
    const routineSelectorEl = document.getElementById('routine-selector');
    const checkButton = document.getElementById('check-button');
    const messageBox = document.getElementById('message-box');
    const authStatusEl = document.getElementById('auth-status');

    const today = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
    authStatusEl.innerHTML = `Fecha: ${today} | Desarrollado por: Jason Dafnis`;

    // === TTS con Web Speech API ===
    function speakText(text) {
        if (!text || typeof speechSynthesis === 'undefined') return;
        speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'es-ES';
        utterance.rate = 0.9;
        const voices = speechSynthesis.getVoices();
        const spanishVoice = voices.find(v => v.lang.startsWith('es-ES'));
        if (spanishVoice) utterance.voice = spanishVoice;
        speechSynthesis.speak(utterance);
    }

    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = () => {};
    }

    // === UTILS ===
    function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    function showMessage(text, classes) {
        messageBox.innerHTML = text;
        messageBox.className = `p-3 text-center rounded-xl font-bold transition-all ${classes}`;
        messageBox.classList.remove('hidden');
        setTimeout(() => messageBox.classList.add('hidden'), 8000);
    }

    // === MODO A ===
    let currentSequence = [];
    let currentCorrectSequence = [];
    let selectedPictoIndex = null;
    let validationStatus = [];

    function renderSequence() {
        dropTargetsEl.innerHTML = '';
        currentSequence.forEach((item, index) => {
            const target = document.createElement('div');
            let classes = 'filled-drop-zone p-4 flex items-center h-24 font-bold transition-all shadow-sm ';
            if (index === selectedPictoIndex) classes += ' selected-picto';
            else if (validationStatus[index] === 'correct') classes += ' picto-correct';
            else if (validationStatus[index] === 'incorrect') classes += ' picto-incorrect';
            target.className = classes + ' w-full';
            target.innerHTML = `<span class="text-3xl font-extrabold mr-4">${index + 1}.</span> 
                                <div class="flex items-center space-x-4">
                                    <span class="text-5xl">${item.emoji}</span>
                                    <span class="text-lg font-bold text-gray-800">${item.text}</span>
                                </div>`;
            target.addEventListener('click', () => {
                speakText(item.text);
                handleTargetClick(index);
            });
            dropTargetsEl.appendChild(target);
        });
    }

    function handleTargetClick(clickedIndex) {
        validationStatus = [];
        if (selectedPictoIndex === null) {
            selectedPictoIndex = clickedIndex;
            showMessage('Pictograma seleccionado. ¡Haz clic en otro para intercambiar!', 'bg-yellow-100 text-yellow-800');
            renderSequence();
        } else {
            if (selectedPictoIndex === clickedIndex) {
                selectedPictoIndex = null;
                showMessage('Selección cancelada.', 'bg-gray-200 text-gray-700');
            } else {
                [currentSequence[selectedPictoIndex], currentSequence[clickedIndex]] = [currentSequence[clickedIndex], currentSequence[selectedPictoIndex]];
                selectedPictoIndex = null;
                showMessage('¡Intercambio realizado! Revisa el orden.', 'bg-green-100 text-green-800');
            }
            renderSequence();
        }
    }

    function loadRoutine(routineKey) {
        const routineData = ROUTINES_DATA[routineKey];
        if (!routineData) return;
        routineTitleEl.textContent = routineData.title;
        currentCorrectSequence = routineData.sequence;
        currentSequence = shuffleArray(routineData.sequence);
        selectedPictoIndex = null;
        validationStatus = [];
        renderSequence();
        messageBox.classList.add('hidden');
    }

    function checkSequence() {
        if (selectedPictoIndex !== null) {
            showMessage('Debes deseleccionar o completar el intercambio antes de verificar.', 'bg-yellow-100 text-yellow-800');
            return;
        }
        const correctValues = currentCorrectSequence.map(item => item.value);
        let allCorrect = true;
        validationStatus = [];
        for (let i = 0; i < currentSequence.length; i++) {
            if (currentSequence[i].value !== correctValues[i]) {
                allCorrect = false;
                validationStatus[i] = 'incorrect';
            } else {
                validationStatus[i] = 'correct';
            }
        }
        if (allCorrect) {
            const msg = '¡Felicidades! 🎉 La secuencia es COMPLETAMENTE CORRECTA. ¡Excelente trabajo!';
            showMessage(msg, 'bg-emerald-100 text-emerald-800');
            speakText('Felicidades! La secuencia es completamente correcta. ¡Excelente trabajo!');
            setTimeout(() => {
                const keys = Object.keys(ROUTINES_DATA);
                const idx = keys.indexOf(routineSelectorEl.value);
                const next = keys[(idx + 1) % keys.length];
                routineSelectorEl.value = next;
                loadRoutine(next);
            }, 3000);
        } else {
            const msg = 'Aún no es correcto. 🧐 Revisa los pasos marcados en rojo e intenta intercambiarlos.';
            showMessage(msg, 'bg-rose-100 text-rose-800');
            speakText('Aún no es correcto. Revisa los pasos marcados en rojo e intenta intercambiarlos.');
        }
        renderSequence();
    }

    // === EVENTOS ===
    routineSelectorEl.addEventListener('change', (e) => loadRoutine(e.target.value));
    checkButton.addEventListener('click', checkSequence);

    // === INICIO ===
    window.onload = () => {
        loadRoutine('morning');
        setTimeout(() => speechSynthesis.getVoices(), 500);
    };
</script>
</body>
</html>
